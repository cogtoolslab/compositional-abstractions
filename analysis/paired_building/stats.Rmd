---
title: "Compositional Abstractions Analyses"
author: "Will McCarthy, Cameron Holdaway, Robert Hawkins"
date: "07/26/2023"
output: html_document
---

# Imports

## Packages

```{r setup, include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(tidyboot)
library(here)
library(scales)

knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

## Configuration

```{r ggplot, include=FALSE}
theme_set(theme_classic())
theme_update(# axis labels
  axis.title = element_text(size = 16),
  axis.text = element_text(size = 16),
  title = element_text(size = 16),
  legend.position = 'FALSE', 
  text = element_text(size=16), 
  element_line(size=1), 
  element_rect(size=2, color="#00000"))

primary_color = '#21606C'
secondary_color = '#22AAAA'

get_tower_set <- function(d) {
  d %>% 
    mutate(towerSet = case_when(
      (leftTarget %in% c('L', 'Pi')) & (rightTarget %in% c('L', 'Pi')) ~ 'L/Pi',
      (leftTarget %in% c('L', 'C')) & (rightTarget %in% c('L', 'C')) ~ 'L/C', 
      (leftTarget %in% c('Pi', 'C')) & (rightTarget %in% c('Pi', 'C')) ~ 'C/Pi'
    )) %>%
    return()
}

```

## Import data

These files are generated by `compabs_analysis_df_generator.ipynb`.
 
### Game-level exit survey data
 
```{r}
df_exit.raw = read_csv(here('results/csv/df_exit.csv'))
```

### Trial-level metadata

```{r}
df_trial.raw = read_csv(here('results/csv/df_trial.csv')) %>%
  get_tower_set() %>%
  mutate(trialNum = as.numeric(as.character(trialNum)),
         repNum = as.numeric(as.character(repNum)) + 1)
```

### Block placement data (builder side)

```{r}
df_block.raw = read_csv(here('results/csv/df_block.csv')) %>%
  get_tower_set() %>%
  mutate(repNum = as.numeric(as.character(repNum)),)
```

### Chat message data (architect side)

```{r}
df_chat.raw = read_csv(here('results/csv/df_chat.csv')) %>%
  mutate(trialNum = as.numeric(as.character(trialNum)),
         repNum = as.numeric(as.character(repNum)))
```

## Exclusion criteria 

Remove trials that don't reach criterion (75% Accuracy on 75% of trials).

It turns out that the exclusions of the first preregistered accuracy check is already a super set of the other exclusions.

```{r}
#How many dyads fulfill 
passedAcc <- df_trial.raw %>% 
  group_by(gameid, trialNum) %>% 
  filter(trialScore > 75  & repNum != 'practice') %>%
  group_by(gameid)%>% 
  tally %>% 
  filter(n/12 >=0.75) %>% 
  distinct(gameid)

# Note that 'yes' means 'yes I understood the instruction'
passedConfused <- df_exit.raw %>% 
  filter(confused == 'yes') %>% 
  distinct(gameid)

#How many dyads said they spoke English
passedEnglish <- df_exit.raw %>% 
  filter(nativeEnglish == 'yes') %>% 
  distinct(gameid)


gamesToKeep = intersect(passedAcc, passedConfused) %>% intersect(passedEnglish) %>% pull(gameid)
```

### Count participants

```{r}
cat('before exclusions:', df_exit.raw$gameid %>% unique() %>% length(), 'games started\n')
cat('after exclusions:', length(gamesToKeep), 'completed in dataset')
```

### Make final version of data frames

```{r}
df_trial <- df_trial.raw %>% 
  filter(!is.na(trialNum)) %>% 
  subset(gameid %in% gamesToKeep)

df_chat <- df_chat.raw %>% 
  filter(!is.na(trialNum)) %>% 
  subset(gameid %in% gamesToKeep)

df_block <- df_block.raw %>% 
  filter(!is.na(trialNum)) %>% 
  subset(gameid %in% gamesToKeep)

df_exit <- df_exit.raw %>% 
  subset(gameid %in% gamesToKeep)
```

# Results

```{r}
bootstrap_seed = 0
```

## Accuracy 

```{r}
set.seed(bootstrap_seed)

acc.indiv <- df_trial %>%
  group_by(repNum, gameid) %>%
  summarize(trialScore = mean(trialScore))

acc.boot <- acc.indiv %>%
  group_by(repNum) %>%
  tidyboot_mean(column=trialScore, nboot=1000)

acc.boot
```

### Figure 3A
```{r}
ggplot(acc.boot, aes(x=repNum, y=empirical_stat)) +
  geom_jitter(aes(y = trialScore), width = 0.1, height = 2, 
              data = acc.indiv, alpha = 0.2) +
  geom_line(size=1.5, color = primary_color) +
  geom_point(size = 4, color = primary_color) +
  geom_errorbar(aes(ymin=ci_lower, ymax = ci_upper), width = 0, size = 1.5,
               color = primary_color) +  
  labs(y = "accuracy (F1)", x = "repetition block", title = 'builder accuracy') +
  scale_y_continuous(limits = c(50,105), breaks = c(50,60,70,80,90,100),
                     labels=c('0.5','0.6','0.7','0.8','0.9','1.0')) +
  theme(legend.position = 'FALSE', 
        aspect.ratio = 1,
        text = element_text(size=16), element_line(size=1), 
        plot.title = element_text(hjust = 0.5, size=16), 
        element_rect(size=2, color="#00000"))
ggsave(here('results/plots/fig3A.pdf'), width=11, height = 11, units='cm', useDingbats = F)
```

### Mixed effects model

```{r}
m.acc <- df_trial %>%
  lmer(trialScore/100 ~ poly(repNum,2) + (1 + poly(repNum,2) | gameid),
       data = .)
summary(m.acc)
```


## Word Count 

```{r}
set.seed(bootstrap_seed)

wc.indiv <- df_trial %>%
  group_by(repNum, gameid) %>%
  summarize(word_count = mean(word_count)) 

wc.boot <- wc.indiv %>%
  group_by(repNum) %>%
  tidyboot_mean(column=word_count, nboot=1000)
wc.boot
```

### Figure 3B

```{r}
wc.boot %>%
  ggplot(aes(x=repNum,y=empirical_stat)) +
    geom_jitter(aes(y = word_count), data = wc.indiv, 
                alpha = 0.2,width =0.1)+
    geom_errorbar(aes(ymin=ci_lower, ymax = ci_upper), width = 0, size = 1.5,
                  data = wc.boot, color = primary_color) +  
    geom_line(size=1.5, color = primary_color)+
    geom_point(size = 4, color = primary_color) +
    labs( y = "words", x = "repetition", title = "words per trial") +
    theme(legend.position = 'FALSE', 
          plot.title = element_text(hjust = 0.5, size=16), 
          aspect.ratio = 1,
          text = element_text(size=16), 
          element_line(size=1),
          element_rect(size=2, color="#00000"))
ggsave(here('results/plots/fig3B.pdf'), width=11, height = 11, units='cm', useDingbats = F)
```

### Mixed effects model

```{r}
m.wc = df_trial %>% 
  lmer(log(word_count) ~ poly(repNum, 2) + (1 + poly(repNum, 2) | gameid) + (1 + poly(repNum, 1)  | towerSet),
       data = .)
summary(m.wc)

# technically as an integer count variable >0, we should be using poisson
m.wc.poisson = df_trial %>% 
  glmer(word_count ~ poly(repNum,1) + (1 + poly(repNum,1) | gameid) + (1 + poly(repNum,1) | towerSet),
       data = ., family = 'poisson')
summary(m.wc.poisson)
```

## Number of discrete messages 

### Figure S1

```{r}
n_messages.indiv <- df_trial %>%
  group_by(repNum, gameid) %>%
  summarize(n_messages = mean(n_messages)) 

n_messages.boot <- n_messages.indiv %>%
  group_by(repNum) %>%
  tidyboot_mean(column=n_messages, nboot=1000) 

n_messages.boot %>%
  ggplot(aes(x=repNum, y=empirical_stat)) +
    geom_jitter(aes(y = n_messages), data = n_messages.indiv, width = 0.1, height = 0.15, alpha = 0.2) +
    geom_errorbar(aes(ymin=ci_lower, ymax = ci_upper), width = 0, size = 1.5, color = primary_color) +  
    geom_line(size=1.5, color = primary_color)+
    geom_point(size = 4, color = primary_color) +
    ylab("messages") +
    xlab("repetition") +
    xlim(c(0.75,4.25)) +
    scale_y_continuous(limits = c(1,6), breaks = c(1,2,3,4,5,6),labels=c(' 1', ' 2',' 3',' 4',' 5',' 6')) +
    theme(legend.position = 'FALSE', aspect.ratio = 1, text = element_text(size=16), 
          element_line(size=1), plot.title = element_text(hjust = 0.5, size=16), element_rect(size=2, color="#00000"))

ggsave(here('results/plots/supplemental_num_messages.pdf'), width=11, height = 11, units='cm', useDingbats = F)
```

### Linear mixed effects model for number of messages

```{r}
m.mes = df_trial %>%
  lmer(n_messages ~ poly(repNum,2) + (1 + poly(repNum,2) | gameid) + (1 + poly(repNum,2) | towerSet),
              data = .)
summary(m.mes)
```

Again, this is count data so we should really be using poisson linking function.

```{r}
m.mes = df_trial %>%
  glmer(n_messages ~ poly(repNum,1) + (1 + poly(repNum,1) | gameid) + (1 + poly(repNum,1) | towerSet),
              data = ., family = 'poisson')
summary(m.mes)
```
# Model
## library contents plot

```{r}
d.lib.props = read_csv(here('results/csv/df_lib_props_block.csv'))
d.lib.props$level <- factor(d.lib.props$level, levels = c("block","subtower", "tower", "scene"))
d.lib.props$cost <- factor(d.lib.props$cost, levels = c("low", "med", "high"))
```

TODO: we should be handling rater variation better (i.e. calculate mixed vs. tower vs. block *within* rater and THEN aggregate proportions) otherwise rater noisiness is going to show up as more 'mixed'.

```{r}
block_color = '#000000'
subtower_color = '#175FFF'
tower_color = '#009948'
scene_color = '#E1AD01'
```

### figure 5A
```{r}
# Sum raw referential expression counts then divide by 4 (since we have 4 raters)
# d.ref = d.ref.raw %>% 
#   group_by(dyad_gameid, trial_num, rep, exp_type) %>% 
#   summarise(sum_ref = sum(n_refs) ) %>%
#   spread(exp_type, sum_ref) %>%
#   mutate(mixType = case_when(block > 0 & tower > 0 ~ 'mixed', 
#                              block > 0 ~ 'block',
#                              tower > 0 ~ 'tower',
#                              TRUE ~ 'none')) %>%
#   group_by(rep, mixType) %>%
#   tally() %>%
#   filter(mixType != 'none')

ggplot(d.lib.props, aes(x=trial, y = prop, fill=level)) + 
  geom_bar(stat="identity", position = 'fill') +
  # scale_fill_manual(values=c('black', "#345FD6", "#3E7E30")) +
  scale_fill_manual(values=c(block_color,subtower_color, tower_color, scene_color)) +
  facet_wrap(~cost, dir="v") +
  scale_x_continuous(breaks = 1:12) +
  scale_y_continuous(position = "right",labels = c("0",".25",".5",".75","1")) +
  ylab("") +
  # xlab("repetition") +
  # ylab('frequency') +
  theme(legend.position = 'FALSE', aspect.ratio = 0.25, strip.text = element_blank(),axis.text.y = element_text(size=10),
        text = element_text(size=12), element_line(size=1),
        element_rect(size=2, color="#00000"))

ggsave(here("results/plots/fig6A.pdf"), width=11, height = 11, units='cm', useDingbats = F)
```


## Referring expression analyses

```{r}
d.ref.long = read_csv(here('results/csv/df_ref_exps.csv'))
d.ref.raw = read_csv(here('results/csv/df_ref_exps_melt.csv'))
```

TODO: we should be handling rater variation better (i.e. calculate mixed vs. tower vs. block *within* rater and THEN aggregate proportions) otherwise rater noisiness is going to show up as more 'mixed'.

```{r}
block_color = '#000000'
subtower_color = '#175FFF'
tower_color = '#009948'
scene_color = '#E1AD01'
```

### Figure 4C
```{r}
# Sum raw referential expression counts then divide by 4 (since we have 4 raters)
d.ref = d.ref.raw %>% 
  group_by(dyad_gameid, trial_num, rep, exp_type) %>% 
  summarise(sum_ref = sum(n_refs) ) %>%
  spread(exp_type, sum_ref) %>%
  mutate(mixType = case_when(block > 0 & tower > 0 ~ 'mixed', 
                             block > 0 ~ 'block',
                             tower > 0 ~ 'tower',
                             TRUE ~ 'none')) %>%
  group_by(rep, mixType) %>%
  tally() %>%
  filter(mixType != 'none')

# ggplot(d.ref, aes(x=rep, y = n, fill=mixType)) + 
#   geom_bar(stat="identity",position = 'fill') +
#   # scale_fill_manual(values=c('black', "#345FD6", "#3E7E30")) +
#   scale_fill_manual(values=c(block_color, subtower_color, tower_color)) +
#   xlab("repetition") +
#   ylab('proportion') +
#   theme(legend.position = 'FALSE', aspect.ratio = 1.3, axis.text.y = element_text(size=12),
#         text = element_text(size=12), element_line(size=1),
#         element_rect(size=2, color="#00000"))

ggplot(d.ref, aes(x=rep, y = n, fill=mixType)) + 
  geom_bar(stat="identity",position = 'fill') +
  scale_fill_manual(values=c(block_color, subtower_color, tower_color)) +
  xlab("repetition") +
  ylab('proportion') +
  xlim(c(0.5,4.5)) +
  theme(legend.position = 'none', aspect.ratio = 1.3, axis.text.y = element_text(size=12),
        text = element_text(size=12), axis.text.x = element_text(size=12),
        axis.line = element_line(size=1),
        rect = element_rect(size=2, color="#00000"))


ggsave(here("results/plots/fig4C.pdf"), width=8, height = 10, units='cm', useDingbats = F)
```

```{r}
aggregate_reps <- d.ref.raw %>% 
  group_by(dyad_gameid, trial_num, rep, exp_type, workerID) %>% 
  summarise(sum_refs = sum(n_refs)) %>%
  group_by(dyad_gameid, rep, exp_type) %>% 
  summarise(mean_refs = mean(sum_refs)) %>%
  group_by(rep, exp_type) %>% 
  tidyboot_mean(mean_refs)
```

### Figure 4B
```{r}
# ggplot(aggregate_reps, aes(x=rep, y=empirical_stat, colour=exp_type)) + geom_line(size = 1.5)+
#   geom_errorbar(aes(ymax=ci_upper, ymin = ci_lower), width = 0, size = 1.5)+
#   geom_point(size = 4) +
#   xlab("repetition")+
#   ylab("# referring expressions")+
#   xlim(c(0.5,4.5)) +
#   # geom_hline(yintercept = 2, linetype = 'dashed', color = "#3E7E30") +
#   geom_hline(yintercept = 2, linetype = 'dashed', color = tower_color) +
#   geom_hline(yintercept = 8, linetype = 'dashed', color = block_color) +
#   theme(legend.position = 'FALSE', aspect.ratio = 1.3, axis.text.y = element_text(size=12),
#         text = element_text(size=12),
#         element_line(size=1),
#         element_rect(size=2, color="#00000"))+
#   # scale_color_manual(values=c("#151515","#3E7E30"))
#   scale_color_manual(values=c(block_color,tower_color))

ggplot(aggregate_reps, aes(x=rep, y=empirical_stat, colour=exp_type)) + 
  geom_line(size = 1.5) +
  geom_errorbar(aes(ymax=ci_upper, ymin = ci_lower), width = 0, size = 1.5)+
  geom_point(size = 4) +
  xlab("repetition") +
  ylab("# referring expressions") +
  xlim(c(0.5,4.5)) +
  geom_hline(yintercept = 2, linetype = 'dashed', color = tower_color) +
  geom_hline(yintercept = 8, linetype = 'dashed', color = block_color) +
  theme(legend.position = 'none', aspect.ratio = 1.3, axis.text.y = element_text(size=12),
        text = element_text(size=12), axis.text.x = element_text(size=12),
        axis.line = element_line(size=1),
        rect = element_rect(size=2, color="#00000")) +
  scale_color_manual(values=c(block_color,tower_color))

ggsave(here('results/plots/fig4B.pdf'), width=8, height = 10, units='cm', useDingbats = F)
```

### Compare regression models

```{r}
d.refexp.linear = d.ref.raw %>%
  lmer(n_refs ~ rep * exp_type + (1 + rep * exp_type | dyad_gameid) ,
       data = ., control = lmerControl(optimizer = 'bobyqa'))

summary(d.refexp.linear)

d.refexp.poisson = d.ref %>%
  glmer(n_refs ~ rep * exp_type + (1 + rep * exp_type | dyad_gameid) ,
       data = ., family = 'poisson',
       glmerControl(optimizer = 'bobyqa'))

summary(m3)
```


# Simulations

## Import and format simulation output

```{r}
library(ggthemes)
d.sim <- read_csv(here('model/convention_formation/webppl_implementation/output/trajectories.csv')) %>%
  mutate(block = floor(trialNum / 3), 
         modelType = floor(chainNum/49) %% 3,
         modelType = case_when(modelType == 0 ~ 'full',
                               modelType == 1 ~ 'noAbstraction', 
                               modelType == 2 ~ 'noConvention')) 
```

## Make accuracy param grid

```{r}
d.sim %>%
  group_by(alpha, beta, epsilon, modelType, block) %>%
  filter(alpha == 5) %>%
  tidyboot_mean(accuracy, nboot = 1) %>%
  ggplot(aes(x = block+1, y = empirical_stat*100, linetype = modelType, group = modelType)) +
    geom_line() +
    geom_errorbar(aes(ymin = ci_lower*100, ymax = ci_upper*100), width = 0) +
    facet_grid(epsilon ~ beta, scales = 'free') +
    labs(y = '% accuracy', x = 'repetition') +
    scale_linetype_manual(values = c('solid','longdash','dotted')) +
    ylim(0, 100) +
    theme_few() +
    theme(legend.position = 'top', aspect.ratio = 1)

ggsave(here('results/plots/supplemental_grid_accuracy.pdf'), width=15, height = 15, units='cm', useDingbats = F)
```

## Make efficiency param grid

```{r}
d.sim %>%
  group_by(alpha, beta, epsilon, block, modelType) %>%
  filter(alpha == 5) %>%
  tidyboot_mean(descriptionLength, nboot = 1) %>%
  ggplot(aes(x = block+1, y = empirical_stat, linetype = modelType, group = modelType)) +
    geom_line() +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    labs(y = 'utterance length', x = 'repetition') +
    scale_linetype_manual(values = c('solid','longdash','dotted')) +
    facet_grid(epsilon ~ beta, scales = 'free') +
    ylim(0, 16) +
    theme_few() +
    theme(legend.position = 'top', aspect.ratio = 1)

ggsave(here('results/plots/supplemental_grid_efficiency.pdf'), width=15, height = 15, units='cm', useDingbats = F)
```

### Make main text fig

```{r}
d.sim.indiv <- d.sim %>%
  filter(alpha == 5, beta == 0.2, epsilon == 0.075) %>%
  pivot_longer(cols = c('descriptionLength', 'accuracy'), names_to = 'metric', values_to = 'm') %>%
  group_by(chainNum, block, metric, modelType) %>%
  summarize(m = mean(m))

d.sim.boot <- d.sim.indiv %>%
  group_by(block, metric, modelType) %>%
  tidyboot_mean(m, nboot = 1) 
  
ggplot(d.sim.boot, aes(x = block, y = empirical_stat, group = modelType, linetype = modelType)) +
    geom_line() +
    #geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    labs(y = '') +
    facet_grid(metric ~ ., scales = 'free') +
    scale_linetype_manual(values = c('solid','longdash','dotted')) +
    theme_few() +
    theme(aspect.ratio = 1)

ggsave(here('results/plots/fig5B.pdf'), width=11, height = 21, units='cm', useDingbats = F)
```

# Supplementary analyses

## Proportion of trials that are perfect reconstructions

We might be worried about the stat above, since they're modeling a bounded F1 score with gaussian error.

We might instead be interested in a stricter accuracy metric, the binary variable corresponding to whether it was a perfect reconstruction or not.

```{r}
set.seed(bootstrap_seed)

perfect.boot <- df_trial %>%
  mutate(perfect = as.numeric(trialScore == 100)) %>%
  group_by(repNum) %>% 
  tidyboot_mean(column=perfect, nboot=1000)
```

```{r}
ggplot(perfect.boot, aes(x=repNum, y=empirical_stat)) +
  geom_errorbar(aes(ymin=ci_lower, ymax = ci_upper), 
                width = 0, size = 1.5, color=primary_color) +  
  geom_line(size=1.5, color=primary_color)+
  geom_point(size = 4, color=primary_color) +
  labs(y = "% perfect reconstruction", x = "Repetition block", title = 'stricter accuracy metric') +
  xlim(c(0.75,4.25)) +
  ylim(c(0.4,1)) +
  theme(legend.position = 'FALSE', text = element_text(size=16), element_line(size=1), 
        plot.title = element_text(hjust = 0.5, size=16), element_rect(size=2, color="#00000"))
```

```{r}
m.acc = df_trial %>% 
  mutate(perfect = trialScore == 100) %>%
  glmer(perfect ~ repNum + (1 + repNum | gameid),
        data = ., family = 'binomial')
summary(m.acc)
```

### Utterance length replicates with character count 

```{r}
set.seed(bootstrap_seed)

cc.boot <- df_trial %>%
  group_by(repNum) %>%
  tidyboot_mean(column=char_count, nboot=1000)
cc.boot
```


```{r}
cc.boot %>%
  ggplot(aes(x=repNum,y=empirical_stat)) +
    geom_errorbar(aes(ymin=ci_lower, ymax = ci_upper), width = 0, size = 1.5,
                  data = cc.boot, color = primary_color) +  
    geom_line(size=1.5, color = primary_color)+
    geom_point(size = 4, color = primary_color) +
    ylab("characters") +
    xlab("repetition") +
    # theme_few() +
    # scale_x_continuous(breaks = round(seq(1, 4, by =1),1)) +
    xlim(c(0.75,4.25)) +
    ylim(c(0,350)) +
    ggtitle('characters per trial') +
    #scale_x_continuous(limits = c(0.6,4.4), breaks = c(1,2,3,4),labels=c('first', '2nd','3rd','final')) +
    # scale_y_continuous(breaks = seq(-0.5,2.5,0.5)) +
    theme(legend.position = 'FALSE', text = element_text(size=16), element_line(size=1), plot.title = element_text(hjust = 0.5, size=16), element_rect(size=2, color="#00000"))
ggsave('./plots/unused/CA_ORLR20_char_count_reps.pdf', width=7, height = 11, units='cm', useDingbats = F)
```

```{r}
m.cc = lmer(data = df_trial, char_count ~ repNum + (1 + repNum || gameid) + (1 | towerSet))
summary(m.cc)
```

### Timing 

Have to exclude participants marked as 'flagged', as techical errors/ connectivity issues mean they had some negative block placement times.

#### Total time to send messages across trials
```{r}
set.seed(bootstrap_seed)

chat.time.boot <- df_trial %>%
  group_by(repNum) %>%
  tidyboot_mean(column=total_chat_duration, nboot=100)
chat.time.boot
```

```{r}
chat.time.boot %>%
  ggplot(aes(x=repNum, y=empirical_stat)) +
    geom_errorbar(aes(ymin=ci_lower, ymax = ci_upper), width = 0, size = 1.5,color = primary_color) +  
    geom_line(size=1.5, color = primary_color)+
    geom_point(size = 4, color = primary_color) +
    ylab("total chat duration (s)") +
    xlab("repetition") +
    # theme_few() +
    # scale_x_continuous(breaks = round(seq(1, 4, by =1),1)) +
    # xlim(c(0.5,4.5)) +  
    # ylim(c(0,7)) +
    #scale_x_continuous(limits = c(0.6,4.4), breaks = c(1,2,3,4),labels=c('first', '2nd','3rd','final')) +
    scale_y_continuous(limits = c(40000,200000), labels = c('40','60','120','160','200')) +
    ggtitle('messaging time') +
    theme(legend.position = 'FALSE', text = element_text(size=16), element_line(size=1), plot.title = element_text(hjust = 0.5, size=16), element_rect(size=2, color="#00000"))
ggsave('./plots/CA_ORLR20_chat_duration_reps.pdf', width=7, height = 11, units='cm', useDingbats = F)
```

```{r}
m.chat.time = lmer(data = df_trial, total_chat_duration ~ repNum + (1 + repNum | gameid) + (1 | towerSet))
summary(m.chat.time)
```



#### Total time to send messages across trials
```{r}
set.seed(bootstrap_seed)

block.time.boot <- df_trial %>%
  group_by(repNum) %>%
  tidyboot_mean(column=total_block_duration, nboot=1000)
```

```{r}
block.time.boot %>%
  ggplot(aes(x=repNum, y=empirical_stat)) +
    geom_errorbar(aes(ymin=ci_lower, ymax = ci_upper), width = 0, size = 1.5, color = primary_color) +  
    geom_line(size=1.5, color = primary_color)+
    geom_point(size = 4, color = primary_color) +
    ylab("total build duration") +
    xlab("repetition") +
    theme_few() +
    theme(legend.position = 'FALSE', text = element_text(size=16), element_line(size=1), element_rect(size=2, color="#00000"))

```

```{r}
m.block.time = lmer(data = df_trial, total_block_duration ~ repNum + (1 + repNum | gameid) + (1 | towerSet))
summary(m.block.time)
```

