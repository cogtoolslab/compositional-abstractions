---
title: "Compabs"
author: "Cameron Holdaway"
date: "7/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(lme4)
library(arm)
```
#### Start by reading in the data (CSV compiled in compabs_analysis.ipynb)
```{r}
df_block = read.csv('df_block.csv')
df_chat = read.csv('df_chat.csv')
df_trial = read.csv('df_trial.csv')
df_exit = read.csv('df_exit.csv')
View(df.block)
```

#### Find GameIDs that satisfy exclusion criteria
```{r}
 
#Preprocessing ensures all dyads in these CSVs have completed all trials

#How many dyads fulfill 75% Accuracy on 75% of trials
  #currently including "score>75" to account for livetest0 which had diff    name
games75 = df_trial %>% 
  group_by(gameid, trialNum) %>% 
  filter(trialScore > 75 | score >75 & repNum != 'practice') %>%
  group_by(gameid)%>% 
  tally %>% 
  filter(n/12 >=0.75) %>% 
  distinct(gameid)

#How many dyads said they were confused <-- this is probably inverse coded...
gamesConfused = df_exit %>% 
  filter(confused == 'yes') %>% 
  distinct(gameid)

#How many dyads said they spoke English
gamesEnglish = df_exit %>% 
  filter(nativeEnglish == 'yes') %>% 
  distinct(gameid)

gamesToKeep = intersect(games75, gamesConfused, gamesEnglish)
gamesToKeep
```

#### Plot first order analyses (word-block-message-score/repNum)
##### Word count/char count per repNum and trialNum
```{r}
df_chat$wordCount = sapply(strsplit(tolower(df_chat$content), " "), length)
df_chat$charCount =  nchar(tolower(df_chat$content))
df_chat$repNum = as.numeric(as.character(df_chat$repNum))
df_chat$trialNum = as.numeric(as.character(df_chat$trialNum))

df_chat %>% 
  select(gameid,repNum,wordCount) %>% 
  group_by(gameid,repNum) %>% 
  summarise(wordCount = sum(wordCount)) %>% 
  group_by(repNum) %>% summarise(wordCountAvg = mean(wordCount)) %>% 
  ggplot(aes(x = repNum, y = wordCountAvg)) + geom_line()

df_chat %>% 
  select(gameid,repNum,charCount) %>% 
  group_by(gameid,repNum) %>% 
  summarise(charCount = sum(charCount)) %>% 
  group_by(repNum) %>% summarise(charCountAvg = mean(charCount)) %>% 
  ggplot(aes(x = repNum, y = charCountAvg)) + geom_line()

```
##### Word count per repNum and trialNum
Join dfs to get score correlations with: numMessages, wordCount

Predictive model for scores?

```{r}
lin = lm(data = df, p ~ tradeoff+prompt.type+jitter)
summary(lin)
lme = lme4::lmer(data = df, p ~ 1 + (1|tradeoff) + (1|prompt.type) + (1|jitter))
lme_null = lme4::lmer(data = df, p ~ 1 + (1|tradeoff) + (1|jitter))
anova(lme,lme_null, test = "Chisq")
lme4::ranef(lme)
arm::se.ranef(lme)
#lme4
#arm
#broom.mixed
broom.mixed::tidy(lme, effects = c('fixed', 'ran_vals'))
lme.table = broom.mixed::tidy(lme, effects = c('fixed', 'ran_vals'))
xtable(lme.table)
```